
@{
    ViewBag.Title = "消息中心";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="search_listheader" style="background:#fff" >
        <div class="search_listheader_l" onclick="window.location.href = '/Account/Index'"><i class="iconfont icon-jiantou-copy1"></i></div>
        <h2> 消息</h2>
    </div>
    <div class="massage" id="massage">
        @*<dl>
            <a href="">
                <dt>
                    <img src="~/Content/img/ad7.png">
                    <em></em>
                </dt>
                <dd>
                    <h3>通知小助手<em>02:21</em></h3>
                    <p>2017-02-16 15:00 预约看房，已与房东联系好...</p>
                </dd>
            </a>
        </dl>
        <dl>
            <a href="">
                <dt>
                    <img src="~/Content/img/ad6.png">
                    <em></em>
                </dt>
                <dd>
                    <h3>指房向在线客服<em>02:21</em></h3>
                    <p>我想再次出价，你帮我生成合同，我该怎么操作呢...</p>
                </dd>
            </a>
        </dl>*@
    </div>
</div>

<script type="text/html" id="msgtemplate">
    {{#  layui.each(d, function(index, item){ }}
    <dl>
        <a href="javascript:;">
            <dt>
                <img src="/Content/img/ad6.png">
                {{# if(item.isRead==0){ }}
                <em></em>
                {{# } }}
            </dt>
            <dd onclick="showMore('{{item.sendContent}}')">
                @*<h3>指房向<em>{{ item.addTime.substring(11,16)}}</em></h3>*@
                <p>{{ $.formatDate(item.addTime,'MM-dd hh:mm')}} {{item.sendContent}}</p>
            </dd>
        </a>
    </dl>
    {{#   }) }}
</script>
<script>
    function loadData()
    {
        $.LayPage({
            elem: '#massage'
                   , Template: '#msgtemplate'
                   , mb: 100
                   , url: globalKey.InterfaceDomain + 'api/users/GetUserMessages'
                   , type: 'post'
                   , load: false
                   , data: { pagesize: 15, UserIdStr: $('#Uid').val() }//参数
                   , success: function (laytpl, next, page, data) {
                       var getTpl = $("#msgtemplate").html();
                       laytpl(getTpl).render(data.data.items, function (html) {
                           //执行下一页渲染，第二参数为：满足“加载更多”的条件，即后面仍有分页
                           //pages为Ajax返回的总页数，只有当前页小于总页数的情况下，才会继续出现加载更多

                           next(html, page < data.data.totalPages);
                           setRead();
                       });
                      
                   }
        });
       
    }
    function setRead()
    {
        try {
            $.ar({
                url: globalKey.InterfaceDomain + "api/users/SetReadMsg"
                           , data:  {  UserIdStr: $('#Uid').val() }
                           , success: function (data) {
                               //静默处理
                               
                           }
            });
        } catch (e) {
            console.log(e.message);
        }
    }
    function showMore(str)
    {
        //layui.use(['laytpl'], function () {
        //    var laytpl = layui.laytpl;
        //    var getTpl = '<div style="padding-top: 46px;">' + str + '</div>';
        //    laytpl(getTpl).render(getTpl, function (contentHtml) {
        //        var headHtml = '<div class="search_listheader" style="background:#fff" ><div class="search_listheader_l" onclick="$.modalCloseALL();"><i class="icon iconfont icon-2"></i></div><h2>  指房向房东用户信息服务协议 </h2></div>';
        //        //var footHtml = '<div class="btmline" style="height:15em;"></div>';
        //        var AllHtml = '<div style="height:' + $('body').height() * 0.99 + 'px;overflow:auto;">' + headHtml + contentHtml + '</div>';
        //        $.modalPage({ html: AllHtml });
        //    });
        //})
    }
    $(function () {
        //loaddata and set read
     
        loadData(); 
       
    })
</script>