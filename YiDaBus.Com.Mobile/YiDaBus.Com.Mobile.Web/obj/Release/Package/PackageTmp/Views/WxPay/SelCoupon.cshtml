@{
    ViewBag.Title = "选择优惠券";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    #div_show {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        border: none;
        -webkit-animation-duration: .5s;
        animation-duration: .5s;
        z-index: -100;
    }

    .div_show_title {
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#12a3f4', endColorstr='#0e86c9', GradientType=0);
        clear: both;
        display: block;
        background: #F5F5F5;
        color: #333333;
        font-weight: 700;
        position: relative;
        height: 30px;
        width: 100%;
    }

    .div_show_font {
        color: #333333;
        float: left;
        font-weight: 700;
        margin: 0.4em 0 0.4em 10px;
    }

    .div_show_btn {
        float: right;
        margin: 0.4em 10px 0.4em 0;
    }

    #mapdetails {
        height: 100%;
        width: 100%;
        border: 5px solid white;
    }
</style>
<div class="container">
    <div class="search_listheader" style="background:#fff">
        <div class="search_listheader_l" onclick="window.location.href = '/WxPay/JsApi?CouponId=' + $.request('CouponId')"><i class="iconfont icon-jiantou-copy1"></i></div>
        <h2> 优惠券</h2>
    </div>
    <div class="quan_use">不使用优惠券<span></span></div>
    <div class="quan">
        <div class="quan_tit"><a href="javascript:;" onclick="showcondition()"><i class="icon iconfont icon-bangzhu"></i> 使用规则</a></div>
        <div class="quan_list"></div>
    </div>
</div>
<!--使用规则-->
<div id="div_show" style="display:none">仅限个人使用</div>
<script type="text/html" id="coupon">
    {{#  layui.each(d, function(index, item){ }}
    {{# if(item.isUse==1||item.isOver == 1){ }}
    <a href="javascript:;">
        <dl class="unuse">
            <dt>
                <h3>{{item.couponName}}</h3>
                <p>有效期至{{item.endTime.substring(0,10)}}</p>
                <span>￥<big>{{item.couponAmount}}</big><em class="couponId_{{item.id}}"></i></em></span>
                {{# if(item.isOver == 1){ }}
                <div class="guoqi"><img width="64" src="/Content/img/guoqi_icon.png"></div>
                {{# } }}
                {{# if(item.isUse==1){ }}
                <div class="guoqi"><img width="64" src="/Content/img/yishiyong_icon.png"></div>
                {{# } }}
            </dt>
            <dd>仅限个人使用</dd>
        </dl>
    </a>
    {{# }else{ }}
    <a href="javascript:;" onclick="ChoseCouponHandler({{item.id}});">
        <dl>
            <dt>
                <h3>{{item.couponName}}</h3>
                <p>有效期至{{item.endTime.substring(0,10)}}</p>
                <span>￥<big>{{item.couponAmount}}</big><em class="couponId_{{item.id}}"></em></span>
            </dt>
            <dd>仅限个人使用</dd>
        </dl>
    </a>
    {{# } }}
    {{# }) }}
</script>
<script>
    function loadresult() {
        var uid = $("#Uid").val();
        $.LayPage({
            elem: '.quan_list'
                , Template: '#coupon'
                , mb: 100
                , url: globalKey.InterfaceDomain + 'api/Coupon/GetCouponByUserId'
                , type: 'post'
                , load: false
                , data: {
                    pagesize: 100,
                    userId: $("#Uid").val()
                }, success: function (laytpl, next, page, data) {
                    //第三步：渲染模版
                    var getTpl = $('#coupon').html();
                    laytpl(getTpl).render(data.data.items, function (html) {
                        //执行下一页渲染，第二参数为：满足“加载更多”的条件，即后面仍有分页
                        //pages为Ajax返回的总页数，只有当前页小于总页数的情况下，才会继续出现加载更多
                        next(html, page < data.data.totalPages);
                        var CouponId = $.request('CouponId');
                        CouponIdParam = CouponId
                        $('.quan_list .couponId_' + CouponIdParam).addClass('quan_check');
                        var onOff = (CouponId == "" || CouponId == "0");
                        if (onOff) {
                            $(".quan_use span").css({ "background": "url(/Content/img/quan_2.png) no-repeat center", "background-size": "cover" });
                        } else {
                            $(".quan_use span").css({ "background": "url(/Content/img/quan_1.png) no-repeat center", "background-size": "cover" })
                        }
                        $(".quan_use").click(function () {
                            if (onOff) {
                                $(".quan_use span").css({ "background": "url(/Content/img/quan_2.png) no-repeat center", "background-size": "cover" });
                            } else {
                                $(".quan_use span").css({ "background": "url(/Content/img/quan_1.png) no-repeat center", "background-size": "cover" })
                            }
                            onOff = !onOff;
                            window.location.href = "/WxPay/JsApi?isauto=0";
                        });
                    });
                }
        });
    };
    function showcondition() {
        mlayer.open({
            content: "<div class=\"div_show_title\"> <span class=\"div_show_font\">详情 </span> <a onclick=\"close_show();\" class=\"div_show_btn\" ><i class=\"icon iconfont icon-guanbi\"></i></a> </div>" + $("#div_show").html()
      , type: 1
     , style: 'position:fixed; left:0; top:0; width:100%; height:100%; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'
        });
    }
    function close_show() {
        $("#div_show").hide();
        var div_show = document.getElementById("div_show");
        div_show.style.zIndex = "-100";
        $.modalCloseALL();
    }
    $(function () {
        loadresult();
    });

    //选择优惠券
    function ChoseCouponHandler(couponId) {
        location.href = "/WxPay/JsApi?CouponId=" + couponId;
        return;
    }
   
</script>